(()=>{"use strict";var e=function(e){var t=document.cookie.match(new RegExp("(?:^|; )".concat(e.replace(/([.$?*|{}()[]\\\/+^])/g,"\\$1"),"=([^;]*)")));return t?decodeURIComponent(t[1]):void 0},t={usersRoot:document.getElementById("users"),canvasRoot:document.getElementById("canvas"),roomLinkBtn:document.getElementById("roomLink"),customColorSelector:document.getElementById("customColor"),customColorIndicator:document.getElementById("customColorIndicator"),contextMenu:document.getElementById("contextMenu"),editContext:document.getElementById("editContext"),deleteContext:document.getElementById("deleteContext"),crocodileBtn:document.getElementById("crocodileBtn"),sapperBtn:document.getElementById("sapperBtn"),gameField:document.getElementById("gameField"),timerBtn:document.getElementById("timerBtn"),timerOutput:document.getElementById("timer"),gamesButtons:document.getElementById("gamesButtons"),tempInputElement:document.getElementById("textarea")},n=160,r="http:"===window.location.protocol?"ws:":"wss:",o=window.location.pathname.replace("/room/",""),a=t.canvasRoot.getContext("2d");a.font="16px sans-serif",a.textAlign="start",a.textBaseline="top",t.customColorIndicator.style.borderColor=t.customColorSelector.value;var c={choosenName:e("".concat(o,":userName"))||window.prompt("Insert your name")||"Guest".concat(Math.floor(100500*Math.random())),admin:e("".concat(o,":admin")),sendDataUpdate:function(){},socketTimeoutId:null,savedElements:[],savedUsers:[],timerCounter:0,timerTimoutId:null,tempInputEditHandler:function(){},tempInputBlurHandler:function(){},pointerCaptureCoordinates:null,doubleClick:!1,doubleClickTimeoutId:null,longTouch:!1,longTouchTimeoutId:null,contextEditHandler:function(){},contextDeleteHandler:function(){},contextMenuOpened:!1,cursorHoveredElements:[],cursorSelectedElements:[],cursorSelectedControlPoint:null,cursorFixedControlPoint:null,workInProgressElement:null,selectionFramePoints:null,imageSize:null,selectedType:"pointer",selectedColor:"#171717",currentScale:1,clipboardElements:[],sapperField:[]};function i(e){return m(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||u(e)||s()}function l(e,t){return m(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a=[],c=!0,i=!1;try{for(n=n.call(e);!(c=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);c=!0);}catch(e){i=!0,o=e}finally{try{c||null==n.return||n.return()}finally{if(i)throw o}}return a}}(e,t)||u(e,t)||s()}function s(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function u(e,t){if(e){if("string"==typeof e)return d(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?d(e,t):void 0}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function m(e){if(Array.isArray(e))return e}document.cookie="".concat(o,":userName=").concat(c.choosenName);var p=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:c.currentScale;return e.pageX||e.pageY?[e.pageX/t,e.pageY/t]:e.touches?[e.touches[0].pageX/t,e.touches[0].pageY/t]:[0,0]},f=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:c.currentScale,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:c.currentScale;return e.pageX||e.pageY?[Math.floor(t.canvasRoot.parentNode.scrollLeft)/r+e.pageX/n,Math.floor(t.canvasRoot.parentNode.scrollTop)/r+e.pageY/n]:e.touches?[Math.floor(t.canvasRoot.parentNode.scrollLeft)/r+e.touches[0].pageX/n,Math.floor(t.canvasRoot.parentNode.scrollTop)/r+e.touches[0].pageY/n]:[0,0]},v=function(e,t,n){return"".concat(e.substring(0,t)).concat(n).concat(e.substring(t))},y=function(e,t,n){return"".concat(e.substring(0,t)).concat(n).concat(e.substring(t+1))},h=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n,r="";return e.split("").forEach((function(e){var n=(r+=e).split(/[\r\n]/),o=n[n.length-1];a.measureText(o).width>t&&(r=o.includes(" ")?y(r,r.lastIndexOf(" "),"\r"):v(r,r.length-1,"\r"))})),r},g=function(e,t,n,r){var o=e-n,a=t-r;return Math.sqrt(Math.pow(o,2)+Math.pow(a,2))},E=function(e,t,n,r,o,a){return(o-e)*(n-e)+(a-t)*(r-t)},b=function(e,t){var n=l(e,2),r=l(n[0],2),o=r[0],a=r[1],c=l(n[1],2),i=c[0],s=c[1],u=l(t,2),d=u[0],m=u[1],p=g(o,a,d,m);if(0===p)return 0;var f=g(i,s,d,m);if(0===f)return 0;var v,y,h,b,C=g(o,a,i,s);return 0===C||E(o,a,i,s,d,m)<=0?p:E(i,s,o,a,d,m)<=0?f:2*(b=((v=C)+(y=p)+(h=f))/2,Math.sqrt(b*(b-v)*(b-y)*(b-h)))/C},C=function(e){var t=l(e,2),n=l(t[0],2),r=n[0],o=n[1],a=l(t[1],2),c=a[0],i=a[1];return[[Math.min(r,c),Math.min(o,i)],[Math.max(r,c),Math.max(o,i)]]},w=function(e,t){var n=l(C(e),2),r=l(n[0],2),o=r[0],a=r[1],c=l(n[1],2),i=c[0],s=c[1];return o<=t[0]&&i>=t[0]&&a<=t[1]&&s>=t[1]},S=function(e,t){var n=l(C(e),2),r=l(n[0],2),o=r[0],a=r[1],c=l(n[1],2),i=c[0],s=c[1];return b([[o,a],[i,a]],t)<=8||b([[o,a],[o,s]],t)<=8||b([[i,a],[i,s]],t)<=8||b([[o,s],[i,s]],t)<=8},I=function(e,t,n){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)<=Math.pow(n,2)},L=function(e,t){for(var n=0;n<e.length;n+=1)if(I(e[n],t,8))return!0;return!1},O=function(e){return[[e[0][0],e[0][1]],[e[1][0],e[0][1]],[e[1][0],e[1][1]],[e[0][0],e[1][1]]]},P=function(e){return"pointer"===e},T=function(e){return"image"===e.type},k=function(e){return"rect"===e.type},x=function(e){return"line"===e.type},R=function(e){return"row"===e.type},j=function(e){return"text"===e.type},M=function(e){return"sticker"===e.type},D=function(e){return j(e)||M(e)},A=function(e){return T(e)||D(e)},B=function(e,t){return[[e[0][0]-t,e[0][1]-t],[e[1][0]+t,e[1][1]+t]]},F=function(e,t,n){return Math.max(t,Math.min(n,e))};function H(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a=[],c=!0,i=!1;try{for(n=n.call(e);!(c=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);c=!0);}catch(e){i=!0,o=e}finally{try{c||null==n.return||n.return()}finally{if(i)throw o}}return a}}(e,t)||N(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function N(e,t){if(e){if("string"==typeof e)return U(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?U(e,t):void 0}}function U(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var q=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.radius,r=void 0===n?5:n,o=t.strokeColor,c=t.fillColor,i=C(e),l=a.fillStyle,s=a.strokeStyle;a.fillStyle=c,a.strokeStyle=o;var u=Math.min(r,(i[1][0]-i[0][0])/2),d=Math.min(r,(i[1][1]-i[0][1])/2);a.beginPath(),a.moveTo(i[0][0]+u,i[0][1]),a.lineTo(i[1][0]-u,i[0][1]),a.quadraticCurveTo(i[1][0],i[0][1],i[1][0],i[0][1]+d),a.lineTo(i[1][0],i[1][1]-d),a.quadraticCurveTo(i[1][0],i[1][1],i[1][0]-u,i[1][1]),a.lineTo(i[0][0]+u,i[1][1]),a.quadraticCurveTo(i[0][0],i[1][1],i[0][0],i[1][1]-d),a.lineTo(i[0][0],i[0][1]+d),a.quadraticCurveTo(i[0][0],i[0][1],i[0][0]+u,i[0][1]),a.closePath(),c&&a.fill(),o&&a.stroke(),a.fillStyle=l,a.strokeColor=s},K={},X=function(e,t){q(e,{strokeColor:t,radius:10})},Y=function(e,t){var n=a.strokeStyle;a.strokeStyle=t,a.beginPath(),a.moveTo(e[0][0],e[0][1]),e.forEach((function(e){a.lineTo(e[0],e[1])})),a.stroke(),a.strokeStyle=n},$=function(e,t,n){var r=a.fillStyle,o=h(t,1/0).split(/[\r\n]/);a.fillStyle=n,o.forEach((function(t,n){a.fillText(t,e[0][0],e[0][1]+2+20*n)})),a.fillStyle=r},G=function(e,t,r){var o,c=h(t,n).split(/[\r\n]/),l=Math.max.apply(Math,function(e){if(Array.isArray(e))return U(e)}(o=c.map((function(e){return a.measureText(e).width||0})))||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(o)||N(o)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}());!function(e,t){q(e.map((function(e){return e.map((function(e){return e+2}))})),{fillColor:"#555"}),q(e,{fillColor:t})}([e[0].map((function(e){return e-4})),[e[0][0]+Math.min(l,n)+4,e[0][1]+20*c.length+4]],r),$(e,t,function(e){var t=function(e){if(e=e.toUpperCase(),/^#[0-9A-F]{6}$/.test(e))return i(e.match(/([0-9A-F]{2})([0-9A-F]{2})([0-9A-F]{2})/)).slice(1).map((function(e){return parseInt(e,16)}));if(/^rgb\(([\d]{1,3}),([\d]{1,3}),([\d]{1,3})\)$/.test(e))return i(e.match(/([\d]{1,3}),([\d]{1,3}),([\d]{1,3})/)).slice(1).map((function(e){return parseInt(e,16)}));throw new Error("".concat(e," is not RGB like"))}(e);return.2126*t[0]+.7152*t[1]+.0722*t[2]}(r)>=165?"#000000":"#ffffff")},J=function(e,t,n){var r=H(C(e),2),o=H(r[0],2),a=o[0],c=o[1],i=H(r[1],2),l=i[0],s=i[1];X([[a-4,c-4],[l+4,s+4]],t),n&&G([[a,c-24]],n,t)},z=function(e){k(e)?X(e.points,e.color):x(e)||R(e)?Y(e.points,e.color):T(e)?function(e,t){if(K[t])a.drawImage(K[t],e[0][0],e[0][1],e[1][0]-e[0][0],e[1][1]-e[0][1]);else{var n=new Image;n.src=t,n.onload=function(){K[t]=n,a.drawImage(K[t],e[0][0],e[0][1],e[1][0]-e[0][0],e[1][1]-e[0][1])}}}(e.points,e.url):j(e)&&e.text?$(e.points,e.text,e.color):M(e)&&e.text&&G(e.points,e.text,e.color)},V=function(){a.clearRect(0,0,t.canvasRoot.width,t.canvasRoot.height),c.savedElements.forEach((function(e){c.workInProgressElement&&e.id===c.workInProgressElement.id||z(e)})),c.savedUsers.forEach((function(e){var t,n,r;e.cursor&&e.online&&c.choosenName!==e.name&&("#63DB93",n=(t=H(e.cursor,2))[0],r=t[1],Y([[n,r],[n+6,r+16],[n+8,r+8],[n+16,r+6],[n,r]],"#63DB93"),$([[e.cursor[0],e.cursor[1]-20]],e.name,"#63DB93"))})),!c.workInProgressElement&&c.cursorHoveredElements.length&&c.cursorHoveredElements.forEach((function(e){J(e.borders||e.points,"#f2c5c5",e.author)})),!c.workInProgressElement&&c.cursorSelectedElements.length&&c.cursorSelectedElements.forEach((function(e){var t;J(e.borders||e.points,"#d26565"),e.borders&&!D(e)&&(t=e.borders,O(t).forEach((function(e){var t,n,r,o,i,s,u,d,m,p,f,v,y,h;d=e,m=c.cursorSelectedControlPoint&&(t=e,r=(n=l(c.cursorSelectedControlPoint,2))[0],o=n[1],s=(i=l(t,2))[0],u=i[1],r===s&&o===u)?8:6,f=(p={fillColor:"white",strokeColor:"black"}).strokeColor,v=p.fillColor,y=a.fillStyle,h=a.strokeStyle,a.fillStyle=v,a.strokeStyle=f,a.beginPath(),a.arc(d[0],d[1],m,0,2*Math.PI,!1),v&&a.fill(),f&&a.stroke(),a.fillStyle=y,a.strokeColor=h})))})),c.selectionFramePoints&&J(c.selectionFramePoints,"#65d265","Selection frame"),c.workInProgressElement&&z(c.workInProgressElement)};function W(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Z(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?W(Object(n),!0).forEach((function(t){Q(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):W(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Q(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}t.canvasRoot.classList.add("pointer");var _=function(e){t.canvasRoot.classList.remove(c.selectedType),c.selectedType=e,t.canvasRoot.classList.add(c.selectedType)};function ee(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function te(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ne(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?te(Object(n),!0).forEach((function(t){re(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):te(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function re(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var oe=function(e,t){var n,r=Math.max(Math.max.apply(Math,function(e){if(Array.isArray(e))return ee(e)}(n=t.map((function(e){return a.measureText(e).width})))||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(n)||function(e,t){if(e){if("string"==typeof e)return ee(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ee(e,t):void 0}}(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),20),o=Math.max(20*t.length,20);e.style.width="".concat(r,"px"),e.style.height="".concat(o,"px"),c.workInProgressElement.points[1]=[c.workInProgressElement.points[0][0]+r,c.workInProgressElement.points[0][1]+o]},ae=function(e){t.tempInputElement.style.left="".concat(e.points[0][0]*c.currentScale-t.canvasRoot.parentNode.scrollLeft,"px"),t.tempInputElement.style.top="".concat(e.points[0][1]*c.currentScale-t.canvasRoot.parentNode.scrollTop,"px"),t.tempInputElement.classList.remove("hidden"),t.tempInputElement.value=e.text||"",t.tempInputElement.focus();var r=h(e.text||"",1/0).split(/[\r\n]/);oe(t.tempInputElement,r),V(),c.tempInputEditHandler=function(o){j(e)?(e.text=o.target.value,r=h(o.target.value,1/0).split(/[\r\n]/)):M(e)&&(e.text=o.target.value,r=h(o.target.value,n).split(/[\r\n]/),o.target.value=r.join("\n")),oe(t.tempInputElement,r),V()},c.tempInputBlurHandler=function(){!function(e){c.sendDataUpdate(ne(ne({},e),{},{action:e.id?"edit":"add"})),t.tempInputElement.removeEventListener("input",c.tempInputEditHandler),t.canvasRoot.removeEventListener("click",c.tempInputBlurHandler),t.tempInputElement.classList.add("hidden"),c.workInProgressElement=null}(e),_("pointer"),document.querySelector("[name=type][value=pointer]").checked=!0},t.tempInputElement.addEventListener("input",c.tempInputEditHandler),t.canvasRoot.addEventListener("click",c.tempInputBlurHandler)};function ce(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}t.canvasRoot.addEventListener("touchstart",(function(){c.longTouchTimeoutId?(c.longTouch=!1,c.longTouchTimeoutId=null):c.longTouchTimeoutId=setTimeout((function(){c.longTouch=!0,c.longTouchTimeoutId=null}),1e3)})),t.canvasRoot.addEventListener("touchend",(function(){c.longTouch=!1,clearTimeout(c.longTouchTimeoutId)}));var ie=function(){t.contextMenu.classList.add("hidden"),t.editContext.classList.remove("hidden"),t.editContext.removeEventListener("click",c.contextEditHandler),t.deleteContext.removeEventListener("click",c.contextDeleteHandler)},le=function(e){e.preventDefault(),!c.contextMenuOpened&&c.cursorSelectedElements.length&&P(c.selectedType)?(c.contextMenuOpened=!0,function(e,n){c.contextDeleteHandler=function(){n.forEach((function(e){c.sendDataUpdate({id:e.id,action:"delete"})})),c.contextMenuOpened=!1,ie(),c.cursorSelectedElements=[]},c.contextEditHandler=function(){D(n[0])&&(c.workInProgressElement=n[0],ae(c.workInProgressElement),c.contextMenuOpened=!1,ie())},n.length>1||!D(n[0])?t.editContext.classList.add("hidden"):t.editContext.addEventListener("click",c.contextEditHandler),t.deleteContext.addEventListener("click",c.contextDeleteHandler);var r,o,a=(r=p(e,1),o=2,function(e){if(Array.isArray(e))return e}(r)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a=[],c=!0,i=!1;try{for(n=n.call(e);!(c=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);c=!0);}catch(e){i=!0,o=e}finally{try{c||null==n.return||n.return()}finally{if(i)throw o}}return a}}(r,o)||function(e,t){if(e){if("string"==typeof e)return ce(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ce(e,t):void 0}}(r,o)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),i=a[0],l=a[1];t.contextMenu.style.left="".concat(i,"px"),t.contextMenu.style.top="".concat(l,"px"),t.contextMenu.classList.remove("hidden")}(e,c.cursorSelectedElements)):(c.contextMenuOpened=!1,ie())};function se(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ue(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?se(Object(n),!0).forEach((function(t){de(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):se(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function de(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var me=function(){c.doubleClickTimeoutId?(clearTimeout(c.doubleClickTimeoutId),c.doubleClick=!0,c.doubleClickTimeoutId=null):c.doubleClickTimeoutId=setTimeout((function(){c.doubleClick=!1,c.doubleClickTimeoutId=null}),300)},pe=function(){c.doubleClick=!1},fe=function(e,t){return function(n){(t&&c.doubleClick||!t&&!c.doubleClick)&&e(n)}};t.canvasRoot.addEventListener("mousedown",me),t.canvasRoot.addEventListener("touchstart",me),t.canvasRoot.addEventListener("mouseup",pe),t.canvasRoot.addEventListener("touchend",pe);var ve=function(e){var t=f(e);if(P(c.selectedType)&&!c.pointerCaptureCoordinates&&!c.workInProgressElement)for(var n=!1,r=c.savedElements.length-1;r>=0;r-=1){var o=c.savedElements[r];if(A(o)&&w(o.points,t)||k(o)&&S(o.points,t)||R(o)&&b(o.points,t)<8||x(o)&&L(o.points,t)){e.ctrlKey?c.cursorSelectedElements.push(o):c.cursorSelectedElements=[o],n=!0;break}e.ctrlKey||n||(c.cursorSelectedElements=[])}V()},ye=function(e){var t=f(e),n=c.pointerCaptureCoordinates[0]-t[0],r=c.pointerCaptureCoordinates[1]-t[1];c.pointerCaptureCoordinates=t,c.cursorSelectedElements.forEach((function(e){e.points=e.points.map((function(e){return[e[0]-n,e[1]-r]})),e.borders=e.borders.map((function(e){return[e[0]-n,e[1]-r]}))})),V()},he=function e(){c.cursorSelectedElements.length&&c.cursorSelectedElements.forEach((function(e){c.sendDataUpdate(ue(ue({},e),{},{action:"move"}))})),c.pointerCaptureCoordinates=null,t.canvasRoot.removeEventListener("mousemove",ye),t.canvasRoot.removeEventListener("mouseup",e),t.canvasRoot.removeEventListener("touchmove",ye),t.canvasRoot.removeEventListener("touchend",e)},ge=function(e){var t=f(e);if(!c.cursorFixedControlPoint){var n=c.cursorSelectedElements[0].borders;c.cursorFixedControlPoint=[n[0][0]===c.cursorSelectedControlPoint[0]?n[1][0]:n[0][0],n[0][1]===c.cursorSelectedControlPoint[1]?n[1][1]:n[0][1]]}var r=c.cursorFixedControlPoint[0]-c.pointerCaptureCoordinates[0],o=c.cursorFixedControlPoint[1]-c.pointerCaptureCoordinates[1];if(0!==r&&0!==o){var a=(c.cursorFixedControlPoint[0]-t[0])/r,i=(c.cursorFixedControlPoint[1]-t[1])/o;0!==a&&0!==i&&(c.pointerCaptureCoordinates=t,c.cursorSelectedElements[0].points=c.cursorSelectedElements[0].points.map((function(e){return[c.cursorFixedControlPoint[0]+(e[0]-c.cursorFixedControlPoint[0])*a,c.cursorFixedControlPoint[1]+(e[1]-c.cursorFixedControlPoint[1])*i]})),c.cursorSelectedElements[0].borders=c.cursorSelectedElements[0].borders.map((function(e){return[c.cursorFixedControlPoint[0]+(e[0]-c.cursorFixedControlPoint[0])*a,c.cursorFixedControlPoint[1]+(e[1]-c.cursorFixedControlPoint[1])*i]})),V())}},Ee=function e(){c.sendDataUpdate(ue(ue({},c.cursorSelectedElements[0]),{},{action:"resize"})),c.pointerCaptureCoordinates=null,c.cursorSelectedControlPoint=null,c.cursorFixedControlPoint=null,t.canvasRoot.removeEventListener("mousemove",ge),t.canvasRoot.removeEventListener("mouseup",e),t.canvasRoot.removeEventListener("touchmove",ge),t.canvasRoot.removeEventListener("touchend",e)},be=function(e){var n=p(e,1),r=Math.floor(c.pointerCaptureCoordinates[0]-n[0]),o=Math.floor(c.pointerCaptureCoordinates[1]-n[1]);t.canvasRoot.parentNode.scrollLeft=r<0?0:r,t.canvasRoot.parentNode.scrollTop=o<0?0:o},Ce=function e(){c.pointerCaptureCoordinates=null,t.canvasRoot.removeEventListener("mousemove",be),t.canvasRoot.removeEventListener("mouseup",e),t.canvasRoot.removeEventListener("touchmove",be),t.canvasRoot.removeEventListener("touchend",e)},we=function(e){c.selectionFramePoints=C([c.pointerCaptureCoordinates,f(e)]),c.cursorSelectedElements=[];for(var t=c.savedElements.length-1;t>=0;t-=1){var n=c.savedElements[t];n.borders[0][0]>c.selectionFramePoints[0][0]&&n.borders[0][1]>c.selectionFramePoints[0][1]&&n.borders[1][0]<c.selectionFramePoints[1][0]&&n.borders[1][1]<c.selectionFramePoints[1][1]&&c.cursorSelectedElements.push(n)}},Se=function e(){t.canvasRoot.removeEventListener("mousemove",we),t.canvasRoot.removeEventListener("mouseup",e),c.selectionFramePoints=null,c.pointerCaptureCoordinates=null},Ie=function(e){P(c.selectedType)&&(c.cursorSelectedControlPoint?(c.pointerCaptureCoordinates=f(e),t.canvasRoot.addEventListener("mousemove",ge),t.canvasRoot.addEventListener("mouseup",Ee),t.canvasRoot.addEventListener("touchmove",ge),t.canvasRoot.addEventListener("touchend",Ee)):c.cursorSelectedElements.length?(c.pointerCaptureCoordinates=f(e),t.canvasRoot.addEventListener("mousemove",ye),t.canvasRoot.addEventListener("mouseup",he),t.canvasRoot.addEventListener("touchmove",ye),t.canvasRoot.addEventListener("touchend",he)):(c.pointerCaptureCoordinates=f(e,1,1),t.canvasRoot.addEventListener("mousemove",be),t.canvasRoot.addEventListener("mouseup",Ce),t.canvasRoot.addEventListener("touchmove",be),t.canvasRoot.addEventListener("touchend",Ce)))},Le=function(e){P(c.selectedType)&&(c.pointerCaptureCoordinates=f(e),t.canvasRoot.addEventListener("mousemove",we),t.canvasRoot.addEventListener("mouseup",Se))};function Oe(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a=[],c=!0,i=!1;try{for(n=n.call(e);!(c=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);c=!0);}catch(e){i=!0,o=e}finally{try{c||null==n.return||n.return()}finally{if(i)throw o}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return Pe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Pe(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Pe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Te(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ke(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Te(Object(n),!0).forEach((function(t){xe(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Te(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function xe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Re=function(){c.cursorSelectedElements.forEach((function(e){c.sendDataUpdate({id:e.id,action:"delete"})})),c.cursorSelectedElements=[],c.cursorSelectedControlPoint=null,c.cursorFixedControlPoint=null,c.workInProgressElement=null,c.selectionFramePoints=null,c.pointerCaptureCoordinates=null};c.admin||t.timerBtn.classList.add("hidden");var je=function(e,t){return Math.floor(t-(new Date-e)/1e3)},Me=function(e){c.timerTimoutId?(t.timerBtn.innerHTML="Start 5min timer",e&&c.sendDataUpdate({action:"stop",type:"timer"})):(t.timerBtn.innerHTML="Stop timer",e&&c.sendDataUpdate({action:"start",type:"timer"}))},De=function(){t.timerOutput.innerHTML="00:00",clearInterval(c.timerTimoutId),t.timerOutput.classList.add("timerAlert"),c.timerTimoutId=null};function Ae(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a=[],c=!0,i=!1;try{for(n=n.call(e);!(c=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);c=!0);}catch(e){i=!0,o=e}finally{try{c||null==n.return||n.return()}finally{if(i)throw o}}return a}}(e,t)||Fe(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Be(e){return function(e){if(Array.isArray(e))return He(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Fe(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Fe(e,t){if(e){if("string"==typeof e)return He(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?He(e,t):void 0}}function He(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Ne=["💀","☠️","👻","⚰️","💩","😭","💔"],Ue=["🚩","🔺","📛","💣","🧨","🖕","⚒️"],qe=["👶","👴🏻","👳🏻","❤️","🤗","😁","😏","😎"],Ke=Ne[0],Xe=Ue[0],Ye=qe[0],$e=["transparent","blue","green","yellow","orange","red","red","darkred","darkred"],Ge=function(e,n){var r=document.createElement("button");r.type="button",r.classList.add("userBtn"),r.innerText=e,r.addEventListener("click",n),t.gamesButtons.appendChild(r)};c.admin&&(Ge("Games: Crocodile",(function(){Me(!1),c.sendDataUpdate({action:"start",type:"game",name:"crocodile"})})),Ge("Games: Sapper",(function(){c.sendDataUpdate({action:"start",type:"game",name:"sapper"})})));var Je=function(e){var n,r;e.games.crocodile&&(n=e.games.crocodile)&&(t.gameField.innerHTML=n,t.gameField.classList.remove("hidden"),setTimeout((function(){t.gameField.innerHTML="",t.gameField.classList.add("hidden"),c.sendDataUpdate({action:"stop",type:"game",name:"crocodile"})}),1e4)),e.games.sapper&&"start"===e.games.sapper.action&&(Ke=Ne[Math.floor(Math.random()*Ne.length)],Xe=Ue[Math.floor(Math.random()*Ue.length)],Ye=qe[Math.floor(Math.random()*qe.length)]),e.games.sapper&&function(e){t.gameField.classList.remove("hidden"),function(e){t.gameField.innerHTML="";var n=e.players.find((function(e){return e.name===c.choosenName})),r=document.createElement("div");r.classList.add("sapperField"),n.dead||(r.addEventListener("click",(function(e){if("BUTTON"===e.target.tagName){e.preventDefault();var t=Be(e.target.parentNode.parentNode.childNodes).indexOf(e.target.parentNode),n=Be(e.target.parentNode.childNodes).indexOf(e.target);c.sendDataUpdate({action:"edit",type:"game",name:"sapper",status:"opened",sector:[t,n]})}})),r.addEventListener("contextmenu",(function(e){if("BUTTON"===e.target.tagName){e.preventDefault();var t=Be(e.target.parentNode.parentNode.childNodes).indexOf(e.target.parentNode),n=Be(e.target.parentNode.childNodes).indexOf(e.target);c.sendDataUpdate({action:"edit",type:"game",name:"sapper",status:"flagged",sector:[t,n]})}})));for(var o=0;o<e.width;o+=1){var a=document.createElement("div");a.classList.add("sapperRow");for(var i=0;i<e.height;i+=1){var l=document.createElement("button");if(l.type="button",l.title=e.field[o][i],l.classList.add("sapperBtn"),/^\d:/.test(e.field[o][i])){var s=Ae(e.field[o][i].split(":"),2),u=s[0],d=s[1];l.innerHTML=u,l.title=d,l.disabled=!0,l.classList.add("sapperOpened"),l.style.color=$e[u]}else if(/^dead:/.test(e.field[o][i])){var m=Ae(e.field[o][i].split(":"),2)[1];l.innerHTML=Ke,l.title=m,l.disabled=!0,l.classList.add("sapperBomb")}else"flagged"===e.field[o][i]&&(l.innerHTML=Xe,l.disabled=!0);a.appendChild(l)}r.appendChild(a),t.gameField.appendChild(r)}var p=document.createElement("ul");e.players.forEach((function(e){var t=e.name,n=e.dead,r=e.opened,o=document.createElement("li");o.innerHTML="".concat(t," [").concat(n?Ke:Ye,"]: ").concat(r),p.appendChild(o)})),t.gameField.appendChild(p)}(e)}(e.games.sapper),e.games.sapper&&"stop"===e.games.sapper.action&&(e.games.sapper,(r=document.createElement("button")).type="button",r.innerHTML="Close",r.classList.add("userBtn"),r.classList.add("closeBtn"),r.addEventListener("click",(function(){t.gameField.innerHTML="",t.gameField.classList.add("hidden"),c.sendDataUpdate({action:"stop",type:"game",name:"sapper"})})),t.gameField.appendChild(r))},ze=function(){t.canvasRoot.style.transform="scale(".concat(c.currentScale,")"),document.getElementById("textarea").style.transform="scale(".concat(c.currentScale,")")},Ve=function(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY;return Math.sqrt(Math.pow(t,2)+Math.pow(n,2))},We=null;function Ze(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Qe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ze(Object(n),!0).forEach((function(t){_e(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ze(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var et=function(e){k({type:c.selectedType})||R({type:c.selectedType})?c.workInProgressElement.points[1]=f(e):x({type:c.selectedType})&&c.workInProgressElement.points.push(f(e)),V()},tt=function e(){c.sendDataUpdate(Qe(Qe({},c.workInProgressElement),{},{action:"add"})),t.canvasRoot.removeEventListener("mousemove",et),t.canvasRoot.removeEventListener("mouseup",e),t.canvasRoot.removeEventListener("touchmove",et),t.canvasRoot.removeEventListener("touchend",e),c.workInProgressElement=null},nt=function(e){var n;n={type:c.selectedType},(T(n)||k(n)||x(n)||R(n))&&(c.workInProgressElement={points:[f(e),f(e)],type:c.selectedType,color:c.selectedColor},t.canvasRoot.addEventListener("mousemove",et),t.canvasRoot.addEventListener("mouseup",tt),t.canvasRoot.addEventListener("touchmove",et),t.canvasRoot.addEventListener("touchend",tt))};t.roomLinkBtn.addEventListener("click",(function(){window.navigator.clipboard.writeText(window.location),alert("Link in clipboard")})),t.canvasRoot.addEventListener("mousedown",nt),t.canvasRoot.addEventListener("touchstart",nt),t.canvasRoot.addEventListener("click",(function(e){D({type:c.selectedType})&&!c.workInProgressElement&&(c.workInProgressElement={points:[f(e),f(e).map((function(e){return e+20}))],type:c.selectedType,color:c.selectedColor,text:""},ae(c.workInProgressElement))})),document.querySelectorAll("[name=type]").forEach((function(e){e.addEventListener("click",(function(e){_(e.target.value)}))})),document.querySelectorAll("[name=color]").forEach((function(e){e.addEventListener("click",(function(e){var t;"custom"!==(t=e.target.value)&&(c.selectedColor=t,c.cursorSelectedElements.length&&c.cursorSelectedElements.forEach((function(e){c.sendDataUpdate(Z(Z({},e),{},{color:c.selectedColor,action:"edit"}))})))}))})),t.customColorSelector.addEventListener("change",(function(e){c.selectedColor=e.target.value,t.customColorIndicator.style.borderColor=e.target.value,c.cursorSelectedElements.length&&c.cursorSelectedElements.forEach((function(e){c.sendDataUpdate(Z(Z({},e),{},{color:c.selectedColor,action:"edit"}))}))})),t.customColorSelector.addEventListener("click",(function(){document.getElementById("customColorFake").checked=!0,c.selectedColor=t.customColorSelector.value,c.cursorSelectedElements.length&&c.cursorSelectedElements.forEach((function(e){c.sendDataUpdate(Z(Z({},e),{},{color:c.selectedColor,action:"edit"}))}))})),t.canvasRoot.addEventListener("mousemove",(function(e){var t,n,r=f(e);if(c.sendDataUpdate({type:"cursor",cursor:r}),P(c.selectedType)&&!c.pointerCaptureCoordinates&&!c.workInProgressElement){var o=function(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).find((function(t){return w(B(t.borders,8),e)}))}(r,c.cursorHoveredElements);c.cursorSelectedControlPoint=o&&o.borders?(t=r,n=o.borders,O(n).find((function(e){return I(e,t,16)}))||null):null,c.cursorHoveredElements=[];for(var a=c.savedElements.length-1;a>=0;a-=1){var i=c.savedElements[a];if(A(i)&&w(i.points,r)||k(i)&&S(i.points,r)||R(i)&&b(i.points,r)<8||x(i)&&L(i.points,r)){c.cursorHoveredElements=[i];break}}}})),t.canvasRoot.addEventListener("mousedown",fe(ve,!1)),t.canvasRoot.addEventListener("touchstart",fe(ve,!1)),t.canvasRoot.addEventListener("mousedown",fe(Le,!0)),t.canvasRoot.addEventListener("touchstart",fe(Le,!0)),t.canvasRoot.addEventListener("mousedown",fe(Ie,!1)),t.canvasRoot.addEventListener("touchstart",fe(Ie,!1)),t.canvasRoot.addEventListener("contextmenu",le),t.canvasRoot.addEventListener("touchstart",(le,function(e){})),t.canvasRoot.addEventListener("dragover",(function(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"})),t.canvasRoot.addEventListener("drop",(function(e){e.stopPropagation(),e.preventDefault();var t=e.dataTransfer.files,n=f(e);t.forEach((function(e){if(e.type.match(/image.*/)){var t=new FileReader;t.onload=function(e){var t=new Image;t.src=e.target.result,t.onload=function(){c.sendDataUpdate({points:[[n[0]-t.width/2,n[1]-t.height/2],[n[0]+t.width/2,n[1]+t.height/2]],url:e.target.result,type:"image",action:"add"})}},t.readAsDataURL(e)}}))})),window.addEventListener("keydown",(function(e){"KeyZ"===e.code&&e.ctrlKey||(("KeyX"===e.code||"KeyC"===e.code)&&e.ctrlKey&&c.cursorSelectedElements.length?(c.clipboardElements=c.cursorSelectedElements,"KeyX"===e.code&&Re()):"KeyV"===e.code&&e.ctrlKey&&c.clipboardElements.length?c.clipboardElements.forEach((function(e){c.sendDataUpdate(ke(ke({},e),{},{points:e.points.map((function(e){var t=Oe(e,2);return[t[0]+5,t[1]+5]})),borders:e.points.map((function(e){var t=Oe(e,2);return[t[0]+5,t[1]+5]})),action:"add"}))})):"Backspace"!==e.code&&"Delete"!==e.code||!c.cursorSelectedElements.length||Re())})),t.canvasRoot.addEventListener("wheel",(function(e){var t=0;e.deltaY>=1?t=.01:e.deltaY<=-1&&(t=-.01),c.currentScale=F(c.currentScale+t,.5,4),ze()})),t.canvasRoot.addEventListener("touchstart",(function(e){e.touches.length>1&&(e.preventDefault(),We=Ve(e))})),t.canvasRoot.addEventListener("touchmove",(function(e){e.touches.length>1&&(e.preventDefault(),c.currentScale=F(Ve(e)/We,.5,4),ze())})),t.timerBtn.addEventListener("click",(function(){Me(!0)})),function e(){var n=new WebSocket("".concat(r,"//").concat(window.location.host,"/stream/").concat(o));n.onopen=function(){c.socketTimeoutId&&(clearInterval(c.socketTimeoutId),c.socketTimeoutId=null),n.send(JSON.stringify({name:c.choosenName}))},n.onmessage=function(e){var n,r=JSON.parse(e.data);r.users&&(n=Object.values(r.users),c.savedUsers=n,t.usersRoot.innerHTML=n.map((function(e){var t=e.name,n=e.online,r=e.admin;return'\n<li class="user '.concat(c.choosenName===t?"ownName":""," ").concat(r?"admin":""," ").concat(n?"online":"offline",'">').concat(t,"</li>\n    ")})).join(""),V()),r.elements&&(c.savedElements=r.elements,V()),r.timer&&"start"===r.timer.action&&function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.id,r=void 0===n?0:n,o=e.from,a=void 0===o?new Date:o,i=e.duration,l=void 0===i?300:i;r&&r!==c.timerCounter&&je(a,l)>0&&(clearInterval(c.timerTimoutId),c.timerTimoutId=setInterval((function(){var e=je(a,l);if(t.timerOutput.classList.remove("timerAlert"),e<=0)De();else{var n=e%60,r=(e-n)/60;t.timerOutput.innerHTML="".concat(String(r).padStart(2,"0"),":").concat(String(n).padStart(2,"0"))}}),1e3)),c.timerCounter=r}(r.timer),r.timer&&"stop"===r.timer.action&&De(r.timer),r.games&&Je(r)},n.onclose=function(){c.socketTimeoutId||(c.socketTimeoutId=setInterval(e,1e3))},n.onerror=function(e){console.error(e.message)},c.sendDataUpdate=function(e){n.send(JSON.stringify(e))}}()})();